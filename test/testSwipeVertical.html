<!doctype html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SwipeVertical</title>
<style>
  body {
    margin: 0px;
  }
  gesture-logger {
    font-size: large;
  }
  .tall {
    height: 20vh;
    border:1px dotted black;
  }
</style>
<h1>SwipeVertical</h1>
<pre>Tested:
- gestures/swipeVertical.js
- effects/pullToRefresh.js

The most challenging parts of testing vertical swipes are on mobile,
the interaction with built-in scroll gesture handlers.
Unfortunatelly, there is no way to write automated tests for this.
</pre>

<div id="d1" style="height:20vh; background-color:#ddd">
Test 1: manual, displays gesture status.<br>
<gesture-logger></gesture-logger>
Drag up and down<br>
On mobile, you can get a feel on how gesture interacts
with browser scroll gestures. 
</div>
<div id="d2" style="height:50vh; background-color:#aaa;overflow:auto;border:1px solid green">
  <div>Test 2: manual, displays spinner on top</div>
  <div id="d2timer"></div>
</div>
<div style="height:50vh; background-color:#999">A div</div>

<script type="module">
  import TestRunner from "./testFramework.js";
  import { LoggerEffect, createEvent, awaitTimeout, awaitSizeStopAnimating } from "./testUtils.js";

  import GestureManager from "../src/gestureManager.js";
  import GestureHandler from "../src/gestures/gestureHandler.js";
  import GestureEffect from "../src/effects/gestureEffect.js";
  import SwipeVertical from "../src/gestures/swipeVertical.js";
  import PullToRefreshEffect from "../src/effects/pullToRefresh.js";

  async function installVerticalOnD1() {
    let el = document.querySelector("#d1");
    let effect = el.querySelector("gesture-logger").gestureEffect;
    let gesture = new SwipeVertical(el, {effect: effect});
    GestureManager.addGesture(gesture);
  }

  async function installVerticalOnD2() {
    let el = document.querySelector("#d2");
    let effect = new PullToRefreshEffect({container: el, testTimerSelector: "#d2timer"});
    let gesture = new SwipeVertical(el, {effect: effect, direction:'utd'});
    GestureManager.addGesture(gesture);
  }

  async function test2auto() {
    let el = document.querySelector(`#d2`);
    el.dispatchEvent(createEvent("pointerdown", el, { top: 5 }));
    el.dispatchEvent(createEvent("pointermove", el, { top: 30 }));
    el.dispatchEvent(createEvent("pointermove", el, { top: 35 }));
    await awaitTimeout(5);  // For initial animation to complete
    el.dispatchEvent(createEvent("pointerup", el, { top: 30 }));
    let spinner = el.querySelector(".defaultPullDownSpinner");
    await awaitSizeStopAnimating(spinner);
    if (spinner.offsetHeight == 0)
      throw "Spinner should be visible after a swipe";
  }

  TestRunner.test(installVerticalOnD1);
  TestRunner.test(installVerticalOnD2);
  TestRunner.test(test2auto);
  // TestRunner.runAll();
  // document.addEventListener("touchmove", 
  //   ev => { 
  //     console.log("touchmove body");
  //     ev.preventDefault();
  //   },
  //   { passive: false });
</script>
