<!doctype html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SwipeLeft test</title>
<style>
body {
  min-height: 100vh;
  margin: 0px;
}
.list {
  width: 100%;
  max-width: 500px;
}
.listItemContainer {
  position: relative;
  width: 100%;
  overflow: hidden;
}
.listItemContent {
  font-size: 36px;
  border: 4px solid gray;
  border-bottom-color: #DDD;
  padding: 4px;
}
</style>
<h1>SwipeLeft test</h1>
<pre>Tested:
- gestures/swipeLeft.js
- effects/swipeLeftButtonMenuEffect.js
- effects/buttonMenu.js
</pre>
<div id="list1" class="list">
</div>
<script type="module">
  // Setup

  for (let i=1;i<=20;++i) {
    // Create list items
    let container = document.createElement("div");
    let content = document.createElement("div");
    container.classList.add("listItemContainer");
    container.append(content);
    content.classList.add("listItemContent");
    content.textContent = `This is a list item ${i}`;
    document.getElementById("list1").append(container);
  }
</script>
<script type="module">
  import GestureManager from "../src/gestureManager.js";
  import SwipeLeft from "../src/gestures/swipeLeft.js";
  import SwipeLeftButtonMenuEffect from "../src/effects/swipeLeftButtonMenuEffect.js";
  import createButtonMenu from  "../src/effects/buttonMenu.js";
  import TestRunner from "./testFramework.js";
  import {LoggerEffect} from "./testUtils.js";

  let nullClickHandler = _ => {};
  let swipeLeftMailMenuOptions = {
    container: null,
    contentSelector: ".listItemContent",
    menuBuilder: createButtonMenu,
    menuBuilderOptions: {
      items: [
        {title: "Moreâ€¦", color: "#c8c7ce", action: nullClickHandler},
        {title: "Flag", color: "#ff9503", action: nullClickHandler},
        {title: "Trash", color: "#ff3a2e",  action: nullClickHandler}
      ]
    }
  };

  function createEvent(type, element, location) {
    let elRect = element.getBoundingClientRect();
  
    let pageX = elRect.x;
    let pageY = elRect.y;
    if (location) {
      if (location.x)
        pageX += location.x;
      if (location.y)
        pageY += location.y;
      if (location.left)
        pageX += location.left;
      if (location.right)
        pageX += elRect.width - location.right;
    }
    let ev = new PointerEvent(type, {
      bubbles: true, 
      timeStamp: 5,
      clientX: pageX - window.scrollX, 
      clientY: pageY - window.scrollY
    });
    return ev;
  }

  async function awaitTimeout(timeout=200) {
    return new Promise((resolve, reject) => {
      window.setTimeout( _ => resolve(), timeout);
    });
  }

  async function awaitSizeStopAnimating(el, timeout=1000) {
    if (el == null)
      return Promise.reject("NULL el passed to awaitSizeStopAnimating");
    let lastWidth;
    let lastHeight;
    let endMillis = Date.now() + timeout;
    return new Promise((resolve, reject) => {
      let interval = window.setInterval( () => {
        if (el.offsetWidth == lastWidth && el.offsetHeight == lastHeight) {
          window.clearInterval(interval);
          resolve();
        }
        if (Date.now() > endMillis) {
          window.clearInterval(interval);
          reject("awaitSizeStopAnimating timed out after " + timeout + "ms");
        }
        lastWidth = el.offsetWidth;
        lastHeight = el.offsetHeight;
      }, 20);
    });
  }

  async function test1() {
    // 1. swipe left so that menu remains visible
    // 2. click in empty area, so that menu goes away
    // Setup
    let container, effect, gesture;

    try {
      container = document.querySelector(".list .listItemContainer");
      swipeLeftMailMenuOptions.container = container;
      effect = new SwipeLeftButtonMenuEffect(swipeLeftMailMenuOptions);
      gesture = new SwipeLeft(container, 
        { effect: effect});
      GestureManager.addGesture(container, gesture);

      // Test
      // swipe left.
      container.dispatchEvent(
        createEvent("pointerdown", container, {right: 5})
      );
      container.dispatchEvent(
        createEvent("pointermove", container, {right: 10})
      );
      container.dispatchEvent(
        createEvent("pointermove", container, {right: 200})
      );
      container.dispatchEvent(
        createEvent("pointerup", container, {right: 200})
      );
      // Wait till end of animation
      await awaitSizeStopAnimating(container.querySelector(".swipeHorizontalMenuItem"));
      // await awaitTimeout(200);
      // 
      container.dispatchEvent(
        createEvent("pointerdown", container, {right: 300})
      );
      container.dispatchEvent(
        createEvent("pointerup", container, {right: 300})
      );
    } catch(err) {
      GestureManager.removeGesture(gesture);
      throw err;
    }
    // Cleanup
    GestureManager.removeGesture(gesture);
  }

  async function test2() {
    // 1. swipe left so that menu remains visible
    // 2. click on the menu button
    let container, effect, gesture;
    let buttonClicked = false;
    try {
      let action = ev => {
        buttonClicked = ev.currentTarget.textContent;
      }
      container = document.querySelector(".list .listItemContainer:nth-child(2)");
      swipeLeftMailMenuOptions.container = container;
      for (let item of swipeLeftMailMenuOptions.menuBuilderOptions.items)
        item.action = action;
      effect = new SwipeLeftButtonMenuEffect(swipeLeftMailMenuOptions);
      gesture = new SwipeLeft(container, 
        { effect: effect});
      GestureManager.addGesture(container, gesture);

      // Test
      // swipe left.
      container.dispatchEvent(
        createEvent("pointerdown", container, {right: 5})
      );
      container.dispatchEvent(
        createEvent("pointermove", container, {right: 10})
      );
      container.dispatchEvent(
        createEvent("pointermove", container, {right: 200})
      );
      container.dispatchEvent(
        createEvent("pointerup", container, {right: 200})
      );
      // Wait till end of animation
      await awaitSizeStopAnimating(container.querySelector(".swipeHorizontalMenuItem"));
      // Click on the button
      let button = container.querySelector(".swipeHorizontalMenuItem:nth-child(3)");
      button.dispatchEvent(
        createEvent("click", button, {y: 5, x: 5})
      );
      if (buttonClicked == false)
        throw "Did not click on the button"
    } catch(err) {
      GestureManager.removeGesture(gesture);
      throw err;
    }
    // Cleanup
    GestureManager.removeGesture(gesture);
    return buttonClicked;
  }

  async function test3() {
    // Install menu on test3
    let container, effect, gesture;
    try {
      container = document.querySelector(".list .listItemContainer:nth-child(3)");
      swipeLeftMailMenuOptions.container = container;
      effect = new SwipeLeftButtonMenuEffect(swipeLeftMailMenuOptions);
      gesture = new SwipeLeft(container, { effect: effect});
      GestureManager.addGesture(container, gesture);
      container.style.backgroundColor = "yellow";
      // Swipe left to open the menu
      container.dispatchEvent(
        createEvent("pointerdown", container, {right: 5})
      );
      container.dispatchEvent(
        createEvent("pointermove", container, {right: 10})
      );
      container.dispatchEvent(
        createEvent("pointerup", container, {right: 200})
      );
    } catch(err) {
      GestureManager.removeGesture(gesture);
      container.style.backgroundColor = "";
      throw err;
    }
  }

  TestRunner.test(test1, "swipe + blank click");
  TestRunner.test(test2, "swipe + menu click");
  TestRunner.test(test3, "Install menu on item 3");
</script>