<!doctype html>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SwipeLeft test</title>
<style>
body {
  min-height: 100vh;
  margin: 0px;
}
.list {
  width: 100%;
  max-width: 500px;
}
.listItemContainer {
  position: relative;
  width: 100%;
  overflow: hidden;
}
.listItemContent {
  font-size: 36px;
  border: 4px solid gray;
  border-bottom-color: #DDD;
  padding: 4px;
}
</style>
<h1>SwipeLeft test</h1>
<pre>Tested:
- gestures/swipeLeft.js
- effects/swipeLeftButtonMenuEffect.js
- effects/buttonMenu.js
</pre>
<div id="list1" class="list">
</div>
<script type="module">
  // Setup

  for (let i=1;i<=20;++i) {
    // Create list items
    let container = document.createElement("div");
    let content = document.createElement("div");
    container.classList.add("listItemContainer");
    container.append(content);
    content.classList.add("listItemContent");
    content.textContent = `This is a list item ${i}`;
    document.getElementById("list1").append(container);
  }
</script>
<script type="module">
  import GestureManager from "../src/gestureManager.js";
  import SwipeLeft from "../src/gestures/swipeLeft.js";
  import SwipeLeftButtonMenuEffect from "../src/effects/swipeLeftButtonMenuEffect.js";
  import createButtonMenu from  "../src/effects/buttonMenu.js";
  import TestRunner from "./testFramework.js";
  import {LoggerEffect} from "./testUtils.js";

  let nullClickHandler = _ => {};
  let swipeLeftMailMenuOptions = {
    container: null,
    contentSelector: ".listItemContent",
    menuBuilder: createButtonMenu,
    menuBuilderOptions: {
      items: [
        {title: "Moreâ€¦", color: "#c8c7ce", click: nullClickHandler},
        {title: "Flag", color: "#ff9503", click: nullClickHandler},
        {title: "Trash", color: "#ff3a2e",  click: nullClickHandler}
      ]
    }
  };

  function createEvent(type, element, location) {
    let elRect = element.getBoundingClientRect();
  
    let pageX = elRect.x;
    let pageY = elRect.y;
    if (location) {
      if (location.x)
        pageX += location.x;
      if (location.y)
        pageY += location.y;
      if (location.left)
        pageX += location.left;
      if (location.right)
        pageX += elRect.width - location.right;
    }
    let ev = new PointerEvent(type, {
      bubbles: true, 
      timeStamp: 5,
      clientX: pageX - window.scrollX, 
      clientY: pageY - window.scrollY
    });
    return ev;
  }

  async function awaitTimeout(timeout=200) {
    return new Promise((resolve, reject) => {
      window.setTimeout( _ => resolve(), timeout);
    });
  }
  async function test1() {
    // 1. swipe left so that menu remains visible
    // 2. click in empty area, so that menu goes away
    // Setup
    let container = document.querySelector(".list .listItemContainer");
    swipeLeftMailMenuOptions.container = container;
    let effect = new LoggerEffect(
      new SwipeLeftButtonMenuEffect(swipeLeftMailMenuOptions));
    let gesture = new SwipeLeft(container, 
      { effect: effect});
    GestureManager.addGesture(container, gesture);

    // Test
    // pointerdown 
    container.dispatchEvent(
      createEvent("pointerdown", container, {right: 5})
    );
    container.dispatchEvent(
      createEvent("pointermove", container, {right: 10})
    );
    container.dispatchEvent(
      createEvent("pointermove", container, {right: 100})
    );
    container.dispatchEvent(
      createEvent("pointermove", container, {right: 200})
    );
    container.dispatchEvent(
      createEvent("pointerup", container, {right: 200})
    );
    // Wait till end of animation
    await awaitTimeout(200);
    
    container.dispatchEvent(
      createEvent("pointerdown", container, {right: 300})
    );
    container.dispatchEvent(
      createEvent("pointerup", container, {right: 300})
    );
    // pointermove - enters waiting
    // pointer move -200px;
    // pointer move -100px;
    // pointer up
    // pointer down 
    // Cleanup
    GestureManager.removeGesture(gesture);
  }

  TestRunner.test(test1, "First test");
</script>